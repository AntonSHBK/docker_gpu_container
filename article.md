### Инструкция по настройке Docker на Windows для работы с интегрированным графическим процессором Intel и XLaunch

Эта инструкция поможет настроить Docker контейнер на Windows с использованием **WSL 2**, **XLaunch** для X11 и интегрированного графического процессора Intel. Мы установим нужные драйверы и обеспечим правильную работу графического рендеринга через Docker Desktop.

#### Шаг 1: Обновление драйверов и установка необходимых компонентов

1. **Обновление драйверов Intel GPU:**
   - Убедись, что у тебя установлены последние драйверы для интегрированной видеокарты Intel.
   - Для этого можно использовать [Intel Driver & Support Assistant](https://www.intel.com/content/www/us/en/support/intel-driver-support-assistant.html).

2. **Обновление WSL 2 с поддержкой GPU:**
   - Открой командную строку (или PowerShell) с правами администратора и обнови WSL:
     ```bash
     wsl --update
     ```

   - Проверь, что твоя версия WSL 2 поддерживает GPU:
     ```bash
     wsl --list --verbose
     ```

3. **Установка WSL 2 GPU драйверов:**
   - Перейди на [страницу поддержки WSL 2 GPU](https://docs.microsoft.com/en-us/windows/wsl/tutorials/gui-apps#supported-gpus) и установи последние драйверы для WSL 2, если они ещё не установлены.

#### Шаг 2: Настройка XLaunch для Windows

1. **Запуск XLaunch**:
   - Скачай и установи **XLaunch** (из [официального сайта](https://sourceforge.net/projects/vcxsrv/)).
   - При запуске выбери следующие параметры:
     - **Multiple Windows** — для возможности открытия нескольких окон.
     - **Disable Native OpenGL** — чтобы избежать конфликтов с OpenGL.
     - **Disable Access Control** — отключить контроль доступа, чтобы Docker контейнер мог подключаться к X-серверу.

2. **Проверка переменной `DISPLAY`:**
   - Обычно `DISPLAY` на Windows через XLaunch работает как `:0`.
   - В контейнере эта переменная должна быть настроена как:
     ```bash
     DISPLAY=host.docker.internal:0
     ```

#### Шаг 3: Настройка Docker Desktop для использования GPU

1. **Включение GPU в Docker Desktop**:
   - Открой **Docker Desktop** и перейди в **Settings** > **Resources** > **WSL Integration**.
   - Включи поддержку WSL 2 для твоей дистрибуции.
   - Убедись, что включена опция "Enable the experimental WSL 2 based engine".

2. **Проверка ресурсов Docker Desktop**:
   - Перейди в **Settings** > **Resources** > **Advanced** и проверь, что включена опция "Use the WSL 2 based engine".

#### Шаг 4: Настройка Docker контейнера

1. Создай файл **Dockerfile** с поддержкой Intel GPU:

   ```Dockerfile
   # Используем образ Intel OneAPI Basekit на базе Ubuntu 22.04
   FROM intel/oneapi-basekit:latest

   # Переключаемся на root
   USER root

   # Устанавливаем необходимые пакеты для графики и OpenCL
   RUN apt-get update && apt-get install -y \
       mesa-utils \
       intel-opencl-icd \
       clinfo \
       libva-dev \
       vainfo \
       libdrm2 \
       libgl1-mesa-dri \
       libxext6 \
       libxrender1 \
       libxtst6 \
       libvulkan1 \
       vulkan-utils \
       i965-va-driver \
       intel-media-va-driver-non-free \
       && rm -rf /var/lib/apt/lists/*

   # Устанавливаем переменные окружения для X11
   ENV DISPLAY=${DISPLAY}
   ENV XAUTHORITY=${XAUTHORITY}
   ENV LIBVA_DRIVER_NAME=i965
   ENV LIBVA_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri

   # Устанавливаем рабочую директорию
   WORKDIR /app

   # Команда по умолчанию — тестирование OpenGL
   CMD ["glxgears"]
   ```

2. Настрой файл **docker-compose.yaml**:

   ```yaml
   version: '3.8'

   services:
     intel_gpu_app:
       build:
         context: .
       container_name: intel_gpu_container
       environment:
         - DISPLAY=host.docker.internal:0         # Настройка DISPLAY для Windows
         - XAUTHORITY=${XAUTHORITY}               # Файл авторизации X11
         - LIBVA_DRIVER_NAME=i965                 # Устанавливаем драйвер для Intel GPU
         - LIBVA_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri
       volumes:
         - /tmp/.X11-unix:/tmp/.X11-unix          # Монтируем сокеты X11 для отображения графики
         - ${XAUTHORITY}:${XAUTHORITY}            # Монтируем файл авторизации для X11
         - /dev/dri:/dev/dri                      # Монтируем устройства GPU
       devices:
         - /dev/dri:/dev/dri                      # Подключение устройства GPU Intel
       privileged: true
       network_mode: "host"
   ```

3. Создай файл **.env** для настройки переменных окружения X11:

   ```bash
   DISPLAY=:0
   XAUTHORITY=${HOME}/.Xauthority
   ```

#### Шаг 5: Запуск контейнера и проверка

1. **Собери образ и запусти контейнер**:

   ```bash
   docker-compose up --build
   ```

2. **Проверка работы OpenCL**:
   Выполни в контейнере:

   ```bash
   clinfo
   ```

   Это покажет информацию о GPU Intel и поддержке OpenCL.

3. **Проверка работы VA-API**:
   Выполни в контейнере:

   ```bash
   vainfo
   ```

   Убедись, что драйвер для Intel GPU правильно загружен.

4. **Проверка рендеринга OpenGL**:
   Запусти графическое приложение, например:

   ```bash
   glxgears
   ```

#### Шаг 6: Дополнительные проверки

Если возникли проблемы с загрузкой драйверов или отображением графики:
- Убедись, что **XLaunch** правильно работает, и что Docker контейнер может подключиться к X11 через переменную `DISPLAY`.
- Если ты используешь Docker Desktop на Windows, убедись, что в настройках включена поддержка GPU через WSL 2.

# Ошибки

Судя по ошибкам, проблема заключается в нескольких моментах, которые возникают при использовании Docker на Windows через WSL 2 и XLaunch:

1. **Ошибка `DRM_IOCTL_I915_GEM_APERTURE failed`** говорит о том, что драйвер для Intel GPU не может корректно получить доступ к графическому процессору.
2. **Ошибка `failed to load driver: zink`** указывает на проблему с OpenGL и Vulkan рендерингом, а также отсутствие аппаратного ускорения.
3. **Переменная окружения `XDG_RUNTIME_DIR`** не установлена, что вызывает проблемы с отображением через X11 и Wayland.

### Возможные причины:
- **Виртуализированная среда Docker Desktop**: Docker на Windows работает через виртуализацию, что может ограничить доступ к аппаратным ресурсам, таким как GPU. Даже при использовании WSL 2 интеграция с графическим процессором может быть неполной.
- **Проблема с драйверами Intel в виртуальной среде**: Поддержка GPU в Docker Desktop на Windows может быть ограничена, особенно если требуется доступ к низкоуровневым интерфейсам GPU (таким как `/dev/dri`).

### Решение

#### 1. **Переменная окружения `XDG_RUNTIME_DIR`**

Убедись, что переменная `XDG_RUNTIME_DIR` установлена в контейнере. Добавь в Dockerfile или в Compose файл:

```Dockerfile
ENV XDG_RUNTIME_DIR=/tmp/runtime-root
RUN mkdir -p /tmp/runtime-root && chmod 700 /tmp/runtime-root
```

Это может помочь с проблемами отображения.

#### 2. **Проблема с `llvmpipe` вместо Intel GPU**

Судя по выводу команды `glxinfo`, графическое рендеринг происходит через программный рендерер **llvmpipe**, а не через Intel GPU. Это может происходить из-за недостаточной поддержки GPU в Docker Desktop на Windows.

Попробуй проверить, доступен ли вообще GPU через WSL 2. Выполни следующую команду:

```bash
wsl --list --verbose
```

Если твоя WSL-дистрибуция имеет версию 2, GPU должен быть поддержан. Однако, в некоторых случаях на Windows через Docker Desktop может не быть полноценного доступа к GPU, особенно если ты используешь интегрированную графику Intel.

#### 3. **Возможное решение — использование Linux-хоста**

На Windows через Docker Desktop и WSL 2 доступ к графическому процессору может быть ограничен. Для полноценной работы с GPU (например, для VA-API, OpenCL и OpenGL) рекомендую попробовать запуск контейнеров напрямую на Linux-хосте, если это возможно.

#### 4. **Проверка через WSL 2 напрямую**

Проверить, работает ли GPU через WSL 2 (без Docker Desktop) можно так:

1. Установи нужные драйверы и зависимости для Intel GPU в WSL 2.
2. Попробуй запустить графическое приложение напрямую через WSL 2 с использованием XLaunch.

Запусти, например:

```bash
glxinfo | grep "OpenGL renderer"
```

Если и в WSL 2 без Docker Desktop проблемы сохраняются, это может свидетельствовать о том, что WSL 2 пока недостаточно поддерживает Intel GPU для твоего случая.

#### 5. **Альтернативные решения**

1. Если ты работаешь с графическими приложениями и OpenCL через Docker, попробуй использовать более низкоуровневые решения, такие как **Linux-хост**.
2. Рассмотри использование облачных сервисов для задач, требующих GPU, если работа с аппаратным ускорением через Docker Desktop слишком ограничена.

К сожалению, текущее ограничение Docker Desktop на Windows через WSL 2 не всегда позволяет полноценно работать с GPU в интегрированной графике Intel.

### Что такое Linux-хост для Docker и почему он может быть полезен для работы с GPU?

**Linux-хост** — это система на базе операционной системы Linux, которая позволяет запускать контейнеры Docker напрямую, без виртуализации или других промежуточных слоев, таких как WSL 2 в Windows или виртуальные машины в Docker Desktop.

Когда ты работаешь с Docker на Windows через Docker Desktop, контейнеры запускаются внутри виртуализированной среды. Это может ограничивать доступ к аппаратным ресурсам, таким как интегрированные графические процессоры (GPU), особенно если ты работаешь с OpenGL, VA-API или OpenCL. Docker Desktop использует виртуальную машину для запуска контейнеров, и многие аппаратные функции, такие как прямой доступ к графическому процессору, могут быть недоступны или ограничены.

На **Linux-хосте** контейнеры работают в нативной среде, что позволяет им напрямую взаимодействовать с аппаратными ресурсами, такими как GPU, без дополнительных виртуальных слоев. Это особенно важно для задач, связанных с графикой, рендерингом и вычислениями на базе GPU.

### Преимущества Linux-хоста для работы с Docker и GPU

1. **Прямой доступ к GPU**: 
   На Linux-хосте Docker контейнеры имеют нативный доступ к устройствам, таким как графические процессоры, что делает возможным полноценное аппаратное ускорение (OpenGL, OpenCL, VA-API и другие).
   
2. **Лучшее управление ресурсами**: 
   Поскольку Linux-хост не использует виртуализацию для Docker контейнеров, все ресурсы (память, процессор и GPU) доступны напрямую без дополнительных накладных расходов.
   
3. **Поддержка драйверов и API**: 
   Linux предоставляет лучшую поддержку драйверов для интегрированных GPU, таких как Intel, благодаря открытым драйверам, таким как `mesa`, `intel-media-va-driver`, и `i965-va-driver`.

4. **Лучшая совместимость с Docker**: 
   Docker был изначально разработан для работы на Linux, и многие функции, такие как доступ к устройствам `/dev/dri`, работают нативно в Linux-среде.

### Как настроить Linux-хост для работы с Docker и GPU

1. **Установка Linux**
   - Для настройки Linux-хоста можно использовать любую распространённую дистрибуцию Linux, такую как:
     - **Ubuntu** (например, версия 22.04 LTS)
     - **Fedora**
     - **Debian**
     - **Arch Linux**
   - Установи Linux как основную операционную систему на физический компьютер или сервер. Также можно использовать виртуальную машину, но для максимальной производительности и работы с GPU рекомендуется физический компьютер.

2. **Установка Docker на Linux**
   После установки Linux необходимо установить Docker:

   - **Ubuntu/Debian**:
     ```bash
     sudo apt update
     sudo apt install docker.io
     ```

   - **Fedora**:
     ```bash
     sudo dnf install docker
     ```

   - **Arch Linux**:
     ```bash
     sudo pacman -S docker
     ```

   После установки Docker обязательно добавь текущего пользователя в группу `docker`, чтобы не использовать `sudo` для каждой команды Docker:

   ```bash
   sudo usermod -aG docker $USER
   ```

   Перезапусти сессию или выполни `newgrp docker`, чтобы изменения вступили в силу.

3. **Настройка GPU-драйверов на Linux**
   В зависимости от твоего GPU, нужно установить соответствующие драйверы:

   - Для **Intel** интегрированной графики:
     - Установи драйверы для графики Intel:
       ```bash
       sudo apt install intel-media-va-driver mesa-utils intel-opencl-icd clinfo
       ```
     - Убедись, что доступ к GPU возможен, выполнив:
       ```bash
       glxinfo | grep "OpenGL renderer"
       ```
       Ожидаемый результат:
       ```
       OpenGL renderer string: Mesa Intel(R) UHD Graphics 620 (KBL GT2)
       ```

   - Для **NVIDIA GPU**:
     - Установи драйверы NVIDIA и инструменты для работы с CUDA:
       ```bash
       sudo apt install nvidia-driver nvidia-docker2
       ```

4. **Настройка Docker для доступа к GPU**
   - Если ты работаешь с графическими приложениями, использующими X11, ты должен подключить X-сервер хоста к контейнеру.
   - Пример Docker Compose файла для подключения X11 и GPU на Linux:

     ```yaml
     version: '3.8'
     
     services:
       gpu_app:
         build:
           context: .
         container_name: gpu_container
         environment:
           - DISPLAY=${DISPLAY}
           - XAUTHORITY=${XAUTHORITY}
           - LIBVA_DRIVER_NAME=i965
           - LIBVA_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri
         volumes:
           - /tmp/.X11-unix:/tmp/.X11-unix
           - ${XAUTHORITY}:${XAUTHORITY}
           - /dev/dri:/dev/dri
         devices:
           - /dev/dri:/dev/dri
         privileged: true
         network_mode: "host"
     ```

5. **Проверка работы с GPU**
   - После запуска контейнера проверь доступ к GPU внутри контейнера:
   
     ```bash
     clinfo
     ```

   - Запусти графическое приложение для тестирования работы GPU:
   
     ```bash
     glxgears
     ```

### Преимущества использования Linux-хоста:

1. **Более высокая производительность**: Прямой доступ к аппаратным ресурсам без виртуализации.
2. **Полная поддержка драйверов**: В Linux встроены драйверы и поддержка технологий, таких как VA-API и OpenCL, для работы с GPU.
3. **Нативная интеграция с Docker**: Docker изначально разработан для Linux, и большинство функций работают без каких-либо ограничений.

### Альтернативные решения:

Если нет возможности использовать физический Linux-хост, можно рассмотреть следующие альтернативы:
1. **Удалённый сервер на Linux**: Например, использование облачных сервисов, таких как AWS или Google Cloud, для запуска контейнеров с поддержкой GPU.
2. **Двойная загрузка Windows и Linux**: Установка Linux на второй раздел диска и загрузка в Linux при необходимости работать с Docker и GPU.
3. **Использование виртуальной машины с поддержкой GPU**: Это возможно, но может привести к снижению производительности.

### Вывод

Linux-хост для Docker предоставляет оптимальные условия для работы с GPU, обеспечивая нативный доступ к аппаратным ресурсам и полную поддержку графических API. Это особенно важно для приложений, которые требуют высокой производительности графики и вычислений, таких как рендеринг, машинное обучение и обработка видео.